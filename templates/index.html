<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pauta do Plenário</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <link href="/static/style.css" rel="stylesheet"/>
</head>
<body>

  <!-- Cabeçalho -->
  <div class="header">
    <div class="container header-wrap">
      <div class="header-logos">
        <img src="/static/logo_camara.png" alt="Logo da Câmara" class="logo"/>
        <img src="/static/logo_pl.png" alt="Logo do PL" class="logo-pl mt-2" />
      </div>
      <div class="header-text">
        <h1 class="titulo-app">Pauta do Plenário</h1>
        <p class="subtitulo-app">Sessões Deliberativas</p>
      </div>
    </div>
  </div>

  <!-- Conteúdo -->
  <div class="container my-4">
    <div class="data-picker">
      <div class="row align-items-end g-3">
        <div class="col-12 col-md-2 d-flex align-items-end gap-2">
          <div class="w-auto">
            <label class="form-label fw-bold mb-1 d-block">
              <i class="fas fa-calendar-alt me-2"></i> Data da sessão
            </label>
            <input type="date" id="dataInput" class="form-control data-input-compact" />
          </div>
          <button id="btnHoje" class="btn btn-outline-secondary btn-sm mb-1">
            <i class="fas fa-calendar-day me-1"></i> Hoje
          </button>
        </div>
        <div class="col-12 col-md-10 text-end">
          <div id="lastUpdate" class="text-muted small mb-1">Atualizado em —</div>
          <button id="btnAtualizar" class="btn btn-primary btn-sm">
            <i class="fas fa-sync-alt me-2"></i> Atualizar
          </button>
        </div>
      </div>
    </div>

    <!-- Indicador de Progresso Principal -->
    <div id="progressContainer" class="progress-container" style="display: none;">
      <div class="progress-header">
        <div class="progress-text">
          <span id="progressText">Carregando dados da sessão...</span>
        </div>
        <button id="btnCancelar" class="btn btn-sm btn-outline-secondary">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="progress-bar-wrapper">
        <div class="progress-bar bg-primary" id="mainProgress" role="progressbar" style="width: 0%"></div>
      </div>
    </div>

    <div id="loading" class="loading">
      <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #007bff;"></i>
      <p class="mt-3" id="loadingText">Carregando dados...</p>
    </div>

    <div id="eventos"></div>
    <div id="pauta"></div>
    <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
  </div>

  <script>
  const dataInput = document.getElementById('dataInput');
  const loading = document.getElementById('loading');
  const loadingText = document.getElementById('loadingText');
  const eventosDiv = document.getElementById('eventos');
  const pautaDiv = document.getElementById('pauta');
  const btnHoje = document.getElementById('btnHoje');
  const btnAtualizar = document.getElementById('btnAtualizar');
  const errorMessage = document.getElementById('errorMessage');
  
  // Elementos do progresso
  const progressContainer = document.getElementById('progressContainer');
  const progressText = document.getElementById('progressText');
  const mainProgress = document.getElementById('mainProgress');
  const btnCancelar = document.getElementById('btnCancelar');
  
  let abortController = null;
  let isCancelled = false;
  let totalItens = 0;
  let loadedItens = 0;

  const hojeISO = new Date().toISOString().split('T')[0];
  dataInput.value = "{{ data }}" || hojeISO;

  function setLoading(on, text = 'Carregando dados...') {
    loading.style.display = on ? 'block' : 'none';
    loadingText.textContent = text;
  }

  function showProgress(show = true) {
    progressContainer.style.display = show ? 'block' : 'none';
    btnCancelar.style.display = show ? 'inline-block' : 'none';
    if (!show) {
      isCancelled = false;
      abortController = null;
    }
  }

  function updateProgress(percentage, text) {
    mainProgress.style.width = `${Math.min(100, percentage)}%`;
    progressText.textContent = text;
  }

  function showError(message) {
    errorMessage.style.display = 'block';
    errorMessage.textContent = message;
    setTimeout(() => {
      errorMessage.style.display = 'none';
    }, 5000);
  }

  function nowBR() {
    const d = new Date();
    const p = n => String(n).padStart(2, '0');
    return `${p(d.getDate())}/${p(d.getMonth() + 1)}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
  }

  function badgeSituacao(s) {
    s = (s || "").toLowerCase();
    if (s.includes("andamento")) return "bg-success";
    if (s.includes("convoc")) return "bg-warning text-dark";
    if (s.includes("encerr")) return "bg-secondary";
    return "bg-info";
  }

  function isMobile() {
    return window.innerWidth < 768;
  }

  function renderEventos(res, data, totalItens = 0) {
    eventosDiv.innerHTML = '';
    if (!res || res.erro || !res.tem_sessao || !Array.isArray(res.eventos) || !res.eventos.length) {
      eventosDiv.innerHTML = '<div class="empty-state"><i class="fas fa-list-ul"></i><h5>Sem Sessão Deliberativa</h5></div>';
      return;
    }
    const ev = res.eventos[0];
    const palavraItem = totalItens === 1 ? 'item' : 'itens';
    eventosDiv.innerHTML = `
      <div class="card evento-card">
        <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
          <div class="me-3">
            <h6 class="mb-1"><strong>Sessão Deliberativa</strong> — ${totalItens} ${palavraItem} na pauta</h6>
            <div class="small text-muted">
              <strong>Data/Hora:</strong> ${ev.data_hora_inicio || 'N/D'} —
              <strong>Situação:</strong> <span class="badge ${badgeSituacao(ev.situacao)}">${ev.situacao || 'N/D'}</span>
              ${ev.descricao ? `<div class="mt-1"><strong>Descrição:</strong> ${ev.descricao}</div>` : ``}
            </div>
          </div>
          <div class="text-muted small">ID: ${ev.id_evento}</div>
        </div>
      </div>`;
  }

  function renderDestaques(destaques_emendas) {
    if (!destaques_emendas || destaques_emendas.length === 0) {
      return `<small class="text-muted">Nenhum destaque/emenda encontrado.</small>`;
    }
    const mobile = isMobile();
    if (mobile) {
      return destaques_emendas.map(d => `
        <div class="destaque-item-mobile mb-2 p-2 bg-light rounded">
          <strong>Número:</strong> ${d.numero || 'N/D'}<br>
          <strong>Autoria:</strong> ${d.autoria || 'N/D'}<br>
          <strong>Descrição:</strong> ${d.descricao || 'N/D'}<br>
          <strong>Tipo Destaque:</strong> ${d.tipo_destaque || 'N/D'}<br>
          <strong>Situação:</strong> <span class="badge bg-info">${d.situacao || 'N/D'}</span>
        </div>
      `).join('');
    } else {
      return `<div class="table-responsive">
        <table class="table table-sm table-striped mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">Número</th>
              <th scope="col">Autoria</th>
              <th scope="col">Descrição</th>
              <th scope="col">Tipo Destaque</th>
              <th scope="col">Situação</th>
            </tr>
          </thead>
          <tbody>
            ${destaques_emendas.map(d => `
              <tr>
                <td><strong>${d.numero || 'N/D'}</strong></td>
                <td>${d.autoria || 'N/D'}</td>
                <td class="text-break">${d.descricao || 'N/D'}</td>
                <td>${d.tipo_destaque || 'N/D'}</td>
                <td><span class="badge bg-info">${d.situacao || 'N/D'}</span></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>`;
    }
  }

  function renderPareceres(pareceres_substitutivos_votos) {
    if (!pareceres_substitutivos_votos || pareceres_substitutivos_votos.length === 0) {
      return `<small class="text-muted">Nenhum parecer PRLP/PRLE encontrado.</small>`;
    }
    const mobile = isMobile();
    if (mobile) {
      return pareceres_substitutivos_votos.map(p => `
        <div class="parecer-item-mobile mb-2 p-2 bg-light rounded">
          <strong>Tipo de Proposição:</strong> ${p.tipo_proposicao || 'N/D'}<br>
          <strong>Data de Apresentação:</strong> ${p.data_apresentacao || 'N/D'}<br>
          <strong>Autor:</strong> ${p.autor || 'N/D'}<br>
          <strong>Descrição:</strong> <span class="text-break">${p.descricao || 'N/D'}</span>
        </div>
      `).join('');
    } else {
      return `<div class="table-responsive">
        <table class="table table-sm table-striped mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">Tipo de Proposição</th>
              <th scope="col">Data de Apresentação</th>
              <th scope="col">Autor</th>
              <th scope="col">Descrição</th>
            </tr>
          </thead>
          <tbody>
            ${pareceres_substitutivos_votos.map(p => `
              <tr>
                <td><strong>${p.tipo_proposicao || 'N/D'}</strong></td>
                <td>${p.data_apresentacao || 'N/D'}</td>
                <td>${p.autor || 'N/D'}</td>
                <td class="text-break">${p.descricao || 'N/D'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>`;
    }
  }

  function renderProcedimentos(procedimentos) {
    if (!procedimentos || procedimentos.length === 0) {
      return `<small class="text-muted">Nenhum requerimento encontrado.</small>`;
    }
    const mobile = isMobile();
    if (mobile) {
      return procedimentos.map(p => `
        <div class="procedimento-item-mobile mb-2 p-2 bg-light rounded">
          <strong>Número:</strong> REQ ${p.numero || 'N/D'}<br>
          <strong>Autoria:</strong> ${p.autoria || 'N/D'}<br>
          <strong>Descrição:</strong> <span class="text-break">${p.descricao || 'N/D'}</span><br>
          <strong>Situação:</strong> <span class="badge bg-info">${p.situacao || 'N/D'}</span><br>
          <strong>Data:</strong> ${p.data || 'N/D'}
        </div>
      `).join('');
    } else {
      return `<div class="table-responsive">
        <table class="table table-sm table-striped mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">Número</th>
              <th scope="col">Autoria</th>
              <th scope="col">Descrição</th>
              <th scope="col">Situação</th>
              <th scope="col">Data</th>
            </tr>
          </thead>
          <tbody>
            ${procedimentos.map(p => `
              <tr>
                <td><strong>REQ ${p.numero || 'N/D'}</strong></td>
                <td>${p.autoria || 'N/D'}</td>
                <td class="text-break">${p.descricao || 'N/D'}</td>
                <td><span class="badge bg-info">${p.situacao || 'N/D'}</span></td>
                <td>${p.data || 'N/D'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>`;
    }
  }

  function renderPauta(res) {
    pautaDiv.innerHTML = '';
    if (!res || res.erro) {
      pautaDiv.innerHTML = '<div class="empty-state"><i class="fas fa-list-ul"></i><h5>Sem pauta</h5></div>';
      return;
    }
    if (!res.tem_pauta || !Array.isArray(res.itens) || !res.itens.length) {
      pautaDiv.innerHTML = '<div class="empty-state"><i class="fas fa-list-ul"></i><h5>Sem pauta</h5></div>';
      return;
    }
    let html = '';
    res.itens.forEach((item, idx) => {
      const nItem = idx + 1;
      const autoresArr = (item.autores?.autores || []).map(a => a.nome);
      const autoresRendered = [...autoresArr, ...(item.autores?.tem_mais_autores ? ['e outros...'] : [])].join(', ') || 'N/D';
      const relatorBadge = item.relator_nome ? `
        <span class="relator-tag">
          ${item.relator_url_foto ? `<img src="${item.relator_url_foto}" class="relator-avatar" alt="foto">` : ``}
          <i class="fas fa-user-tie"></i>
          Relator: ${item.relator_nome}${item.relator_sigla_partido ? ` (${item.relator_sigla_partido})` : ``}
        </span>` : '';
      const linkDestaques = `https://www.camara.leg.br/pplen/destaques.html?codOrgao=180&codProposicao=${item.id_proposicao}`;
      const linkPareceres = `https://www.camara.leg.br/proposicoesWeb/prop_pareceres_substitutivos_votos?idProposicao=${item.id_proposicao}`;
      const linkProcs = `https://www.camara.leg.br/pplen/requerimentos-proposicao.html?codOrgao=180&codProposicao=${item.id_proposicao}`;
      html += `
        <div class="card pauta-card mb-3">
          <div class="card-body">
            <div class="pauta-header" data-bs-toggle="collapse" data-bs-target="#col-${item.id_proposicao}">
              <h6 class="proposicao-titulo">
                <i class="fas fa-file-alt text-primary me-2"></i>
                Item ${nItem} — ${item.titulo || 'N/D'} — Autor: ${autoresRendered}
                <i class="fas fa-chevron-down collapse-toggle-icon"></i>
              </h6>
              <div class="small text-muted d-flex justify-content-between align-items-center">
                <span>
                  <strong>Situação:</strong> <span id="sit-${item.id_proposicao}">${item.descricao_situacao || 'N/D'}</span>
                  ${relatorBadge ? ` — ${relatorBadge}` : ``}
                </span>
                <span class="ms-auto">
                  <small>ID: ${item.id_proposicao}</small>
                </span>
              </div>
            </div>

            <div class="collapse" id="col-${item.id_proposicao}">
              ${item.ementa ? `
                <div class="mb-2">
                  <small class="text-muted d-block mb-1"><i class="fas fa-align-left me-1"></i> <strong>Ementa:</strong></small>
                  <div class="ementa">${item.ementa}</div>
                </div>` : ``}

              <div class="bloco-interno">
                <h6><i class="fas fa-exclamation-circle me-2 text-warning"></i>Destaques e Emendas Aglutinativas:
                  <a href="${linkDestaques}" target="_blank" class="ms-2 text-decoration-none"><i class="fas fa-link"></i></a>
                </h6>
                <div id="destaques-${item.id_proposicao}" class="loading-section">
                  Carregando destaques...
                </div>
              </div>

              <div class="bloco-interno">
                <h6><i class="fas fa-file-contract me-2 text-info"></i>Histórico de Pareceres, Substitutivos e Votos:
                  <a href="${linkPareceres}" target="_blank" class="ms-2 text-decoration-none"><i class="fas fa-link"></i></a>
                </h6>
                <div id="pareceres-${item.id_proposicao}" class="loading-section">
                  Carregando pareceres...
                </div>
              </div>

              <div class="bloco-interno">
                <h6><i class="fas fa-gavel me-2 text-primary"></i>Requerimentos Procedimentais:
                  <a href="${linkProcs}" target="_blank" class="ms-2 text-decoration-none"><i class="fas fa-link"></i></a>
                </h6>
                <div id="procedimentos-${item.id_proposicao}" class="loading-section">
                  Carregando procedimentos...
                </div>
              </div>
            </div>
          </div>
        </div>`;
    });
    pautaDiv.innerHTML = html;
  }

  async function loadDetails(id_proposicao) {
    if (isCancelled) return;

    const destaquesDiv = document.getElementById(`destaques-${id_proposicao}`);
    const pareceresDiv = document.getElementById(`pareceres-${id_proposicao}`);
    const procedimentosDiv = document.getElementById(`procedimentos-${id_proposicao}`);

    if (!destaquesDiv || !pareceresDiv || !procedimentosDiv) {
      console.warn(`Elementos DOM para proposição ${id_proposicao} não encontrados.`);
      return;
    }

    try {
      const [destaquesRes, pareceresRes, procedimentosRes] = await Promise.all([
        fetch(`/api/proposicao/${id_proposicao}/destaques`, { signal: abortController?.signal }).then(r => r.json()),
        fetch(`/api/proposicao/${id_proposicao}/pareceres`, { signal: abortController?.signal }).then(r => r.json()),
        fetch(`/api/proposicao/${id_proposicao}/procedimentos`, { signal: abortController?.signal }).then(r => r.json())
      ]);

      if (!isCancelled) {
        destaquesDiv.innerHTML = renderDestaques(destaquesRes.destaques_emendas);
        pareceresDiv.innerHTML = renderPareceres(pareceresRes.pareceres_substitutivos_votos);
        procedimentosDiv.innerHTML = renderProcedimentos(procedimentosRes.procedimentos);
        loadedItens++;

        const progress = (loadedItens / totalItens) * 100;
        const palavraItem = totalItens === 1 ? 'item' : 'itens';
        updateProgress(progress, `Carregando detalhes... ${loadedItens}/${totalItens} ${palavraItem}`);
      }
    } catch (error) {
      if (!isCancelled) {
        console.error(`Erro ao carregar detalhes para ${id_proposicao}:`, error);
        if (destaquesDiv) destaquesDiv.innerHTML = '<small class="text-danger">Erro ao carregar.</small>';
        if (pareceresDiv) pareceresDiv.innerHTML = '<small class="text-danger">Erro ao carregar.</small>';
        if (procedimentosDiv) procedimentosDiv.innerHTML = '<small class="text-danger">Erro ao carregar.</small>';
        loadedItens++;

        const progress = (loadedItens / totalItens) * 100;
        const palavraItem = totalItens === 1 ? 'item' : 'itens';
        updateProgress(progress, `Carregando detalhes... ${loadedItens}/${totalItens} ${palavraItem}`);
      }
    }
  }

  btnCancelar.onclick = () => {
    isCancelled = true;
    if (abortController) {
      abortController.abort();
      abortController = null;
    }
    showProgress(false);
    updateProgress(0, 'Carregamento cancelado pelo usuário');
    setTimeout(() => {
      progressContainer.style.display = 'none';
    }, 2000);
  };

  btnHoje.onclick = () => { dataInput.value = hojeISO; carregarTudo(); };
  btnAtualizar.onclick = () => carregarTudo();
  dataInput.addEventListener('change', carregarTudo);

  // Removido o evento resize para evitar recarregamento no scroll
  // window.addEventListener('resize', () => {
  //   if (document.getElementById('pauta')?.innerHTML) {
  //     carregarTudo();
  //   }
  // });

  async function carregarTudo() {
    // Limpa conteúdo anterior
    eventosDiv.innerHTML = '';
    pautaDiv.innerHTML = '';
    errorMessage.style.display = 'none';
    loadedItens = 0;
    totalItens = 0;

    const data = dataInput.value;
    if (!data) return;

    abortController = new AbortController();
    isCancelled = false;

    setLoading(true);

    try {
      const evRes = await fetch(`/api/eventos/${data}`, { signal: abortController.signal }).then(r => {
        if (!r.ok) throw new Error(`Erro na requisição: ${r.status}`);
        return r.json();
      });

      const pautaRes = await fetch(`/api/pauta/${data}`, { signal: abortController.signal }).then(r => {
        if (!r.ok) throw new Error(`Erro na requisição: ${r.status}`);
        return r.json();
      });
      totalItens = pautaRes.itens?.length || 0;

      renderEventos(evRes, data, totalItens);
      renderPauta(pautaRes);
      document.getElementById('lastUpdate').textContent = `Atualizado em ${nowBR()}`;

      const palavraItem = totalItens === 1 ? 'item' : 'itens';
      if (totalItens > 0) {
        showProgress(true);
        updateProgress(0, `Carregando dados da sessão...`);
        setTimeout(() => {
          updateProgress(40, `Carregando detalhes de ${totalItens} ${palavraItem}...`);
          setLoading(false);
        }, 10);
        const promises = pautaRes.itens.map(item => loadDetails(item.id_proposicao));
        await Promise.all(promises);

        if (!isCancelled) {
          updateProgress(100, `Carregamento concluído! ${totalItens} ${palavraItem} processados.`);
        }
      } else {
        updateProgress(100, 'Sem itens na pauta para esta data.');
        setLoading(false);
      }

    } catch (error) {
      console.error('Erro ao carregar dados:', error);
      setLoading(false);
      showProgress(false);
      showError(`Erro ao carregar dados: ${error.message}. Verifique o console para mais detalhes.`);
    } finally {
      setLoading(false);
      setTimeout(() => {
        if (!isCancelled) {
          showProgress(false);
        }
      }, 2000);
    }
  }

  document.addEventListener('DOMContentLoaded', carregarTudo);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<style>
.progress-container {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  padding: 1rem;
  margin-bottom: 2rem;
}

.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.progress-text {
  font-weight: 500;
}

.progress-bar-wrapper {
  background: #e9ecef;
  border-radius: 6px;
  height: 8px;
  overflow: hidden;
  margin-bottom: 0.5rem;
}

.progress-bar {
  transition: width 0.3s ease;
  height: 100%;
}

#btnCancelar {
  display: none;
}

#btnCancelar:hover {
  background-color: #dc3545;
  color: white;
}

/* Remove spinners das seções individuais */
.loading-section .spinner-border {
  display: none !important;
}

/* Exibe o loading quando ativo */
.loading {
  text-align: center;
  padding: 2rem;
}

.loading .fas {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</body>
</html>
